



<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-gray-100 p-8">


<!-- Main content container -->
<div class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-7xl mx-auto">
    <!-- Header and Logout Button -->
    <div class="flex justify-between items-center mb-6">
        <h2 class="text-3xl font-bold text-gray-800">Admin Dashboard</h2>
        <button onclick="logout()" class="px-4 py-2 bg-red-600 text-white rounded-lg shadow-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-50 transition ease-in-out duration-150">
            Logout
        </button>
    </div>


    <!-- Quick Actions Panel -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
        <div class="bg-indigo-500 text-white rounded-xl p-6 shadow-lg flex items-center justify-between">
            <div>
                <h3 class="text-xl font-semibold">Total Customers</h3>
                <p id="total-customers" class="text-3xl font-bold mt-2">...</p>
            </div>
            <i class="fas fa-users text-4xl opacity-50"></i>
        </div>
        <div class="bg-green-500 text-white rounded-xl p-6 shadow-lg flex items-center justify-between">
            <div>
                <h3 class="text-xl font-semibold">Verified KYC</h3>
                <p id="verified-kyc" class="text-3xl font-bold mt-2">...</p>
            </div>
            <i class="fas fa-user-check text-4xl opacity-50"></i>
        </div>
        <div class="bg-yellow-500 text-white rounded-xl p-6 shadow-lg flex items-center justify-between">
            <div>
                <h3 class="text-xl font-semibold">Pending KYC</h3>
                <p id="pending-kyc" class="text-3xl font-bold mt-2">...</p>
            </div>
            <i class="fas fa-hourglass-half text-4xl opacity-50"></i>
        </div>
        <div class="bg-gray-500 text-white rounded-xl p-6 shadow-lg flex items-center justify-between">
            <div>
                <h3 class="text-xl font-semibold">Rejected KYC</h3>
                <p id="rejected-kyc" class="text-3xl font-bold mt-2">...</p>
            </div>
            <i class="fas fa-user-times text-4xl opacity-50"></i>
        </div>
    </div>


    <!-- Loan Applications Section -->
    <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
        <h3 class="text-2xl font-bold text-gray-800 mb-4">Loan Applications</h3>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Loan ID</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Customer Name</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                </tr>
                </thead>
                <tbody id="loan-applications-list" class="bg-white divide-y divide-gray-200">
                <!-- Data will be loaded dynamically -->
                </tbody>
            </table>
        </div>
    </div>


    <section class="apply-section py-5">
        <div class="container mx-auto">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-gray-800">Loan Products List</h2>
                <a href="../LoanProducts/admin-add-loan.html" class="px-4 py-2 bg-green-600 text-white rounded-lg shadow hover:bg-green-700 transition">+ Add New Loan</a>
            </div>
            <div class="overflow-x-auto bg-white rounded-xl shadow-lg">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Product ID</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Loan Name</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Interest Rate (%)</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Min Amount (₹)</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Max Amount (��)</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Max Tenure (Months)</th>
                        <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr>
                    </thead>
                    <tbody id="loan-products-list" class="bg-white divide-y divide-gray-200">
                    <!-- Data will be loaded dynamically -->
                    </tbody>
                </table>
            </div>
        </div>
    </section>


    <!-- Placeholder Sections for Future Development -->
<!--    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">-->
<!--        <div class="bg-white rounded-xl shadow-lg p-6">-->
<!--            <h3 class="text-2xl font-bold text-gray-800 mb-4">Loan Product Summary</h3>-->
<!--            <p class="text-gray-600">This section will list all active loan products with their details. It will also include options to add, update, and delete products.</p>-->
<!--        </div>-->
<!--        <div class="bg-white rounded-xl shadow-lg p-6">-->
<!--            <h3 class="text-2xl font-bold text-gray-800 mb-4">Repayment Monitoring</h3>-->
<!--            <p class="text-gray-600">This panel will provide insights into upcoming and overdue repayments, helping you manage the loan portfolio effectively.</p>-->
<!--        </div>-->
<!--        <div class="bg-white rounded-xl shadow-lg p-6">-->
<!--            <h3 class="text-2xl font-bold text-gray-800 mb-4">Reports & Analytics</h3>-->
<!--            <p class="text-gray-600">Here you will be able to generate and export reports on loan trends, repayment performance, and more.</p>-->
<!--        </div>-->
<!--        <div class="bg-white rounded-xl shadow-lg p-6">-->
<!--            <h3 class="text-2xl font-bold text-gray-800 mb-4">Notifications & Alerts</h3>-->
<!--            <p class="text-gray-600">This section will display real-time alerts for pending KYC verifications and overdue payments.</p>-->
<!--        </div>-->
<!--    </div>-->


</div>


<script>
    $(document).ready(function() {
        const loggedInCustomer = localStorage.getItem("loggedInCustomer");
        if (!loggedInCustomer) {
            window.location.href = "login.html";
            return;
        }


        const userData = JSON.parse(loggedInCustomer);
        if (userData.userRole !== 'ADMIN') {
            window.location.href = "login.html";
            return;
        }


        fetchLoanApplications();
        fetchDashboardData(); // Keep this for summary cards
        fetchLoanProducts();
    });


    // Fetches loan applications for the dashboard
    function fetchLoanApplications() {
        $.ajax({
            url: "http://localhost:8089/api/application/all",
            method: "GET",
            success: function(data) {
                const loanApplicationsList = $("#loan-applications-list");
                loanApplicationsList.empty();


                if (!data || data.length === 0) {
                    loanApplicationsList.append('<tr><td colspan="5" class="text-center py-4 text-gray-500">No loan applications found.</td></tr>');
                    return;
                }


                data.forEach(loan => {
                    loanApplicationsList.append(`
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${loan.loanId}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${loan.customerName || loan.customerId || ''}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${loan.loanAmount}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${loan.approvalStatus || loan.status}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                <button onclick="updateLoanStatus(${loan.loanId}, 'APPROVE')" class="text-green-600 hover:text-green-900 mx-2">Approve</button>
                                <button onclick="updateLoanStatus(${loan.loanId}, 'REJECT')" class="text-red-600 hover:text-red-900 mx-2">Reject</button>
                            </td>
                        </tr>
                    `);
                });
            },
            error: function() {
                alert("Failed to load loan applications.");
            }
        });
    }


    // Sends an update request to the backend for a loan application status
    function updateLoanStatus(loanId, action) {
        let url;
        if (action === 'APPROVE') {
            url = `http://localhost:8089/api/loans/approve/${loanId}`;
        } else if (action === 'REJECT') {
            url = `http://localhost:8089/api/loans/reject/${loanId}`;
        }


        if (url) {
            $.ajax({
                url: url,
                method: "PUT",
                contentType: "application/json",
                success: function(data) {
                    alert(`Loan application status updated.`);
                    fetchLoanApplications(); // Refresh the loan applications list
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    console.error("AJAX Error:", textStatus, errorThrown, jqXHR.responseText);
                    alert("Failed to update loan application status. Please check the console for details.");
                }
            });
        }
    }


    // Fetches all necessary data for the dashboard
    function fetchDashboardData() {
        // Fetch all customers for overview and pending list
        $.ajax({
            url: "http://localhost:8089/api/customers",
            method: "GET",
            success: function(data) {
                const pendingKycList = $("#pending-kyc-list");
                pendingKycList.empty();


                let totalCustomers = data.length;
                let verifiedKyc = 0;
                let pendingKyc = 0;
                let rejectedKyc = 0;


                data.forEach(customer => {
                    switch(customer.kycStatus) {
                        case 'VERIFIED':
                            verifiedKyc++;
                            break;
                        case 'PENDING':
                            pendingKyc++;
                            // Populate pending applications table
                            pendingKycList.append(`
                                <tr class="hover:bg-gray-50">
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${customer.customerid}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${customer.name}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${customer.email}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">
                                            ${customer.kycStatus}
                                        </span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                        <button onclick="updateKycStatus(${customer.customerid}, 'APPROVE')" class="text-green-600 hover:text-green-900 mx-2">Approve</button>
                                        <button onclick="updateKycStatus(${customer.customerid}, 'REJECT')" class="text-red-600 hover:text-red-900 mx-2">Reject</button>
                                    </td>
                                </tr>
                            `);
                            break;
                        case 'REJECTED':
                            rejectedKyc++;
                            break;
                    }
                });


                // Update summary cards
                $("#total-customers").text(totalCustomers);
                $("#verified-kyc").text(verifiedKyc);
                $("#pending-kyc").text(pendingKyc);
                $("#rejected-kyc").text(rejectedKyc);
            },
            error: function() {
                alert("Failed to load dashboard data.");
            }
        });
    }


    // Sends an update request to the backend for a customer's KYC status
    function updateKycStatus(customerId, action) {
        let url;
        if (action === 'APPROVE') {
            url = `http://localhost:8089/api/customers/approve/${customerId}`;
        } else if (action === 'REJECT') {
            url = `http://localhost:8089/api/customers/reject/${customerId}`;
        }


        if (url) {
            $.ajax({
                url: url,
                method: "PUT",
                contentType: "application/json",
                success: function(data) {
                    alert(`Customer KYC status updated.`);
                    fetchDashboardData(); // Refresh the entire dashboard
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    console.error("AJAX Error:", textStatus, errorThrown, jqXHR.responseText);
                    alert("Failed to update KYC status. Please check the console for details.");
                }
            });
        }
    }


    // Fetches loan products for the dashboard
    function fetchLoanProducts() {
        $.ajax({
            url: "http://localhost:8089/api/products/all",
            method: "GET",
            success: function(data) {
                const loanProductsList = $("#loan-products-list");
                loanProductsList.empty();
                if (!data || data.length === 0) {
                    loanProductsList.append('<tr><td colspan="7" class="text-center py-4 text-gray-500">No loan products found.</td></tr>');
                data.forEach(product => {
                    loanProductsList.append(`
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${product.productId}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${product.loanName}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${product.interestRate}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${product.minAmount}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${product.maxAmount}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${product.maxTenure}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-center text-sm font-medium">
                                <button class="inline-flex items-center px-3 py-1 bg-blue-600 text-white rounded-lg shadow hover:bg-blue-700 transition mr-2"><i class="fas fa-edit mr-1"></i>Edit</button>
                                <button class="inline-flex items-center px-3 py-1 bg-red-600 text-white rounded-lg shadow hover:bg-red-700 transition"><i class="fas fa-trash-alt mr-1"></i>Delete</button>
                            </td>
                        </tr>
                    `);
                });
            },
            error: function() {
                alert("Failed to load loan products.");
            }
        });
    }


    // Logs out the user and redirects to the login page
    function logout() {
        localStorage.removeItem("loggedInCustomer");
        window.location.href = "login.html";
    }
</script>


</body>
</html>
